# 飞书长连接配置指南

## 当前状态
✅ WebSocket 长连接已成功建立
✅ 心跳正常（ping/pong）
❌ 未收到消息事件

## 问题诊断

长连接正常，但没有收到消息事件，说明**飞书开发者后台配置不完整**。

## 配置步骤

### 1. 进入飞书开发者后台
访问：https://open.feishu.cn/app
选择你的应用：**App ID: cli_a89c1f43fc38900b**

### 2. 启用「事件订阅」
导航路径：`应用功能` → `事件订阅`

#### 2.1 启用长连接模式
- 选择 **「长连接模式」**（而不是 Webhook 模式）
- 这样飞书会通过 WebSocket 推送事件，不需要配置回调 URL

#### 2.2 订阅「接收消息」事件
在事件列表中找到并**添加**以下事件：
```
接收消息 v2.0
事件类型：im.message.receive_v1
```

**重要提示：**
- ✅ 必须选择 **v2.0** 版本（P2 协议）
- ❌ 不要选择 v1.0 版本

### 3. 添加权限
导航路径：`权限管理` → `添加权限`

需要添加的权限：
```
✅ 获取与发送单聊、群组消息
   - im:message（读写权限）
   - im:message:send_as_bot（发送消息）

✅ 读取用户发给机器人的单聊消息
   - im:message:p2p:readonly

✅ 接收群聊中@机器人消息事件
   - im:message:group:readonly
   - im:message:mention:readonly

✅ 获取群组信息
   - im:chat:readonly
```

### 4. 发布版本
配置完成后，需要：
1. 点击右上角 **「创建版本」**
2. 填写版本信息
3. 提交审核（如果是企业内部应用，可以直接发布）

**关键：** 配置修改后必须发布新版本才能生效！

### 5. 将机器人添加到群聊
1. 打开飞书群聊
2. 点击群设置 → 群机器人
3. 添加你的机器人

### 6. 测试
在群里 @机器人 发送消息，例如：
```
@机器人名称 今天订单
@机器人名称 帮助
```

## 验证日志

发送消息后，检查 API 日志：

```bash
docker logs delivery_api -f --tail 50
```

**成功的日志示例：**
```
📨 收到飞书消息事件（长链接）
   消息ID: om_xxx
   群聊ID: oc_xxx
   聊天类型: group
   消息类型: text
   内容: 今天订单
🔍 解析命令...
✅ 识别命令: {'type': 'daily_summary', 'params': {'date': '2025-12-23'}}
💭 生成响应...
📤 发送响应...
✅ 消息已回复
```

## 常见问题

### Q1: 长连接断开
**现象：** 日志中出现 `disconnected` 或 `connection closed`

**解决方案：**
- 检查网络稳定性
- 检查 App Secret 是否正确
- 重启 API 容器：`docker-compose restart api`

### Q2: 收不到消息事件
**现象：** 只有 ping/pong，没有消息事件

**可能原因：**
1. ❌ 未启用「长连接模式」（还在使用 Webhook 模式）
2. ❌ 未订阅 `im.message.receive_v1` 事件
3. ❌ 订阅了 v1.0 而不是 v2.0（P2 协议）
4. ❌ 配置修改后未发布版本
5. ❌ 权限不足

**解决方案：** 按照上述配置步骤重新检查

### Q3: 有消息事件但发送失败
**现象：** 收到消息但回复失败，错误码 99991401

**原因：** 缺少发送消息权限

**解决方案：** 
1. 进入 `权限管理`
2. 添加 `im:message:send_as_bot` 权限
3. 发布新版本

### Q4: 私聊正常，群聊不工作
**原因：** 缺少群聊相关权限

**解决方案：**
添加权限：
- `im:message:group:readonly`
- `im:message:mention:readonly`

## 技术细节

### 长连接 vs Webhook

| 特性 | 长连接模式 | Webhook 模式 |
|-----|----------|-------------|
| 实时性 | ⚡ 极高（毫秒级） | 🐌 较低（秒级） |
| 部署 | 简单（无需公网 IP） | 复杂（需要 ngrok 或公网 IP） |
| 稳定性 | 需要保持连接 | 无状态，更稳定 |
| 适用场景 | 内部服务、实时交互 | 生产环境、高可用 |

当前使用：**长连接模式**（无需 ngrok）

### 代码架构

```
FastAPI 启动
    ↓
后台线程启动 WebSocket 客户端
    ↓
连接到 wss://msg-frontier.feishu.cn
    ↓
心跳保持连接（ping/pong）
    ↓
收到消息事件 → do_p2_im_message_receive_v1()
    ↓
解析命令 → 生成响应 → 回复消息
```

## 下一步

配置完成后：
1. 在群里 @机器人 发送 "帮助" 查看可用命令
2. 测试订单查询：`今天订单`、`昨天订单`
3. 测试汇总：`今天汇总`、`本周汇总`

祝使用愉快！🎉

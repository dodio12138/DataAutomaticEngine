# é£ä¹¦æœºå™¨äººæ¶æ„è®¾è®¡

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é£ä¹¦å¼€æ”¾å¹³å°                            â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ ç”¨æˆ·è¾“å…¥ â”‚ â”€â”€â”€> â”‚  é£ä¹¦ç¾¤  â”‚ â”€â”€â”€> â”‚ äº‹ä»¶æ¨é€ â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ HTTP POST
                              â”‚ /feishu/bot/callback
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DataAutomaticEngine API                   â”‚
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              routers/feishu_bot.py                     â”‚ â”‚
â”‚  â”‚              ï¼ˆè·¯ç”±å±‚ - å…¥å£ï¼‰                          â”‚ â”‚
â”‚  â”‚  â€¢ POST /feishu/bot/callback  - é£ä¹¦äº‹ä»¶å›è°ƒ           â”‚ â”‚
â”‚  â”‚  â€¢ GET  /feishu/bot/health    - å¥åº·æ£€æŸ¥               â”‚ â”‚
â”‚  â”‚  â€¢ POST /feishu/bot/test      - æœ¬åœ°æµ‹è¯•               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                         â”‚                                     â”‚
â”‚                         â–¼                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚      services/feishu_bot/message_handler.py           â”‚ â”‚
â”‚  â”‚              ï¼ˆæ ¸å¿ƒå¤„ç†å±‚ï¼‰                             â”‚ â”‚
â”‚  â”‚                                                         â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚  handle_event()                              â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ URLéªŒè¯äº‹ä»¶                               â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ æ¶ˆæ¯æ¥æ”¶äº‹ä»¶                              â”‚     â”‚ â”‚
â”‚  â”‚  â”‚  â€¢ å…¶ä»–äº‹ä»¶...                              â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                      â”‚                                       â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚         â–¼                          â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ CommandParserâ”‚          â”‚   Responder  â”‚              â”‚
â”‚  â”‚  (è§£æå±‚)    â”‚          â”‚   (å“åº”å±‚)   â”‚              â”‚
â”‚  â”‚              â”‚          â”‚              â”‚              â”‚
â”‚  â”‚ parse()      â”‚          â”‚ create_*_    â”‚              â”‚
â”‚  â”‚ â€¢ æ­£åˆ™åŒ¹é…   â”‚          â”‚ response()   â”‚              â”‚
â”‚  â”‚ â€¢ æå–å‚æ•°   â”‚          â”‚              â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                    â”‚                        â”‚
â”‚                                    â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         services/report_service.py                     â”‚ â”‚
â”‚  â”‚              ï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰                            â”‚ â”‚
â”‚  â”‚  â€¢ query_order_summary()     - æŸ¥è¯¢è®¢å•æ±‡æ€»           â”‚ â”‚
â”‚  â”‚  â€¢ generate_daily_summary_text() - ç”Ÿæˆæ¯æ—¥æ±‡æ€»       â”‚ â”‚
â”‚  â”‚  â€¢ generate_store_summary_text() - ç”Ÿæˆåº—é“ºæ±‡æ€»       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                       â”‚                                       â”‚
â”‚                       â–¼                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                  PostgreSQL                            â”‚ â”‚
â”‚  â”‚            (raw_orders, stores, etc.)                  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµ

### 1. ç”¨æˆ·å‘é€æ¶ˆæ¯æµç¨‹

```
ç”¨æˆ·åœ¨é£ä¹¦ç¾¤å‘é€: "æŸ¥è¯¢2025-12-22"
    â”‚
    â–¼
é£ä¹¦å¹³å°æ¥æ”¶æ¶ˆæ¯
    â”‚
    â–¼
é£ä¹¦æ¨é€äº‹ä»¶åˆ°: POST /feishu/bot/callback
    â”‚
    â–¼
feishu_bot.router æ¥æ”¶è¯·æ±‚
    â”‚
    â–¼
MessageHandler.handle_event(event_data)
    â”‚
    â”œâ”€> åˆ¤æ–­äº‹ä»¶ç±»å‹: im.message.receive_v1
    â”‚
    â”œâ”€> è§£ææ¶ˆæ¯å†…å®¹: {"text": "æŸ¥è¯¢2025-12-22"}
    â”‚
    â–¼
CommandParser.parse("æŸ¥è¯¢2025-12-22")
    â”‚
    â”œâ”€> æ­£åˆ™åŒ¹é…: r'æŸ¥è¯¢.*?(\d{4}-\d{2}-\d{2})'
    â”‚
    â”œâ”€> æå–å‚æ•°: {'date': '2025-12-22'}
    â”‚
    â–¼
è¿”å›å‘½ä»¤å¯¹è±¡: 
{
    'type': 'query_orders',
    'params': {'date': '2025-12-22'},
    'raw_text': 'æŸ¥è¯¢2025-12-22'
}
    â”‚
    â–¼
MessageHandler._execute_command()
    â”‚
    â”œâ”€> æ ¹æ® type='query_orders' åˆ†å‘
    â”‚
    â–¼
Responder.create_order_query_response({'date': '2025-12-22'})
    â”‚
    â”œâ”€> è°ƒç”¨ report_service.query_order_summary('2025-12-22')
    â”‚
    â”œâ”€> ä»æ•°æ®åº“æŸ¥è¯¢è®¢å•æ•°æ®
    â”‚
    â”œâ”€> æ ¼å¼åŒ–ä¸ºé£ä¹¦æ¶ˆæ¯æ ¼å¼
    â”‚
    â–¼
è¿”å›å“åº”:
{
    "msg_type": "text",
    "content": {
        "text": "ğŸ“Š ç†ŠçŒ«å¤–å– 2025-12-22 è®¢å•æ•°æ®æ±‡æ€»\n..."
    }
}
    â”‚
    â–¼
é£ä¹¦å¹³å°æ¥æ”¶å“åº”å¹¶å‘é€ç»™ç”¨æˆ·
```

## æ¨¡å—èŒè´£

### è·¯ç”±å±‚ (routers/feishu_bot.py)
- **èŒè´£**: HTTPè¯·æ±‚å¤„ç†ã€è·¯ç”±åˆ†å‘
- **ä¸è´Ÿè´£**: ä¸šåŠ¡é€»è¾‘ã€å‘½ä»¤è§£æ
- **å¯¹å¤–æ¥å£**:
  - `POST /feishu/bot/callback` - ç”Ÿäº§ç¯å¢ƒé£ä¹¦å›è°ƒ
  - `POST /feishu/bot/test` - å¼€å‘æµ‹è¯•æ¥å£
  - `GET /feishu/bot/health` - å¥åº·æ£€æŸ¥

### æ ¸å¿ƒå¤„ç†å±‚ (services/feishu_bot/message_handler.py)
- **èŒè´£**: äº‹ä»¶åˆ†å‘ã€æµç¨‹åè°ƒ
- **ä¾èµ–**: CommandParser, Responder
- **æ ¸å¿ƒæ–¹æ³•**:
  - `handle_event()` - ç»Ÿä¸€äº‹ä»¶å…¥å£
  - `_execute_command()` - å‘½ä»¤æ‰§è¡Œåè°ƒ

### è§£æå±‚ (services/feishu_bot/command_parser.py)
- **èŒè´£**: è‡ªç„¶è¯­è¨€ç†è§£ã€å‚æ•°æå–
- **ç‰¹ç‚¹**: æ— çŠ¶æ€ã€å¯ç‹¬ç«‹æµ‹è¯•
- **æ‰©å±•ç‚¹**: `self.patterns` å­—å…¸

### å“åº”å±‚ (services/feishu_bot/responder.py)
- **èŒè´£**: æ¶ˆæ¯æ ¼å¼åŒ–ã€ä¸šåŠ¡è°ƒç”¨
- **ä¾èµ–**: report_service
- **ç‰¹ç‚¹**: ç»Ÿä¸€å“åº”æ ¼å¼ã€æ˜“äºæ‰©å±•æ¶ˆæ¯ç±»å‹

### ä¸šåŠ¡é€»è¾‘å±‚ (services/report_service.py)
- **èŒè´£**: æ•°æ®æŸ¥è¯¢ã€æŠ¥å‘Šç”Ÿæˆ
- **ç‰¹ç‚¹**: ç‹¬ç«‹äºé£ä¹¦ï¼Œå¯è¢«å…¶ä»–æ¨¡å—å¤ç”¨

## è®¾è®¡åŸåˆ™

### 1. å•ä¸€èŒè´£åŸåˆ™
æ¯ä¸ªæ¨¡å—åªè´Ÿè´£ä¸€ä»¶äº‹ï¼š
- CommandParser åªç®¡è§£æ
- Responder åªç®¡å“åº”
- MessageHandler åªç®¡åè°ƒ

### 2. å¼€é—­åŸåˆ™
å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼š
- æ–°å¢å‘½ä»¤ï¼šåªéœ€æ·»åŠ æ¨¡å¼å’Œå“åº”æ–¹æ³•
- ä¸å½±å“ç°æœ‰å‘½ä»¤çš„å®ç°

### 3. ä¾èµ–å€’ç½®åŸåˆ™
é«˜å±‚æ¨¡å—ä¸ä¾èµ–ä½å±‚æ¨¡å—ï¼š
- MessageHandler ä¾èµ–æŠ½è±¡ï¼ˆParser/Responderæ¥å£ï¼‰
- ä¸šåŠ¡é€»è¾‘ç‹¬ç«‹äºé£ä¹¦å®ç°

### 4. æ¥å£éš”ç¦»åŸåˆ™
å®¢æˆ·ç«¯ä¸åº”ä¾èµ–å®ƒä¸ä½¿ç”¨çš„æ¥å£ï¼š
- æµ‹è¯•æ¥å£ä¸ç”Ÿäº§æ¥å£åˆ†ç¦»
- æ¯ä¸ªæ–¹æ³•åŠŸèƒ½æ˜ç¡®å•ä¸€

## æ‰©å±•ç¤ºä¾‹

### æ·»åŠ æ–°å‘½ä»¤ï¼š"è§¦å‘çˆ¬è™«"

#### 1. CommandParser æ·»åŠ æ¨¡å¼
```python
self.patterns = {
    'trigger_crawler': [
        r'çˆ¬å–.*?(\d{4}-\d{2}-\d{2})',
        r'æŠ“å–.*?è®¢å•',
    ],
    # ...
}
```

#### 2. Responder æ·»åŠ å“åº”æ–¹æ³•
```python
def create_crawler_trigger_response(self, params: Dict) -> Dict:
    """è§¦å‘çˆ¬è™«å¹¶è¿”å›å“åº”"""
    # è°ƒç”¨çˆ¬è™«API
    # è¿”å›è§¦å‘ç»“æœ
    pass
```

#### 3. MessageHandler æ·»åŠ åˆ†å‘
```python
elif command_type == 'trigger_crawler':
    return self.responder.create_crawler_trigger_response(params)
```

## æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
```python
# æµ‹è¯•å‘½ä»¤è§£æ
parser = CommandParser()
assert parser.parse("æŸ¥è¯¢2025-12-22")['type'] == 'query_orders'

# æµ‹è¯•å“åº”ç”Ÿæˆ
responder = Responder()
response = responder.create_help_response()
assert response['msg_type'] == 'text'
```

### é›†æˆæµ‹è¯•
```bash
# ä½¿ç”¨æµ‹è¯•æ¥å£
curl -X POST "http://localhost:8000/feishu/bot/test?text=å¸®åŠ©"
```

### E2Eæµ‹è¯•
- é…ç½®æµ‹è¯•ç¾¤
- å‘é€çœŸå®æ¶ˆæ¯
- éªŒè¯æœºå™¨äººå“åº”

## æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¤„ç†
å¯¹äºè€—æ—¶æ“ä½œï¼ˆå¦‚çˆ¬è™«è§¦å‘ï¼‰ï¼Œä½¿ç”¨å¼‚æ­¥ä»»åŠ¡ï¼š
```python
# ç«‹å³å“åº”ç”¨æˆ·
return {"text": "ä»»åŠ¡å·²æäº¤ï¼Œè¯·ç¨åæŸ¥è¯¢"}
# åå°æ‰§è¡Œè€—æ—¶ä»»åŠ¡
background_tasks.add_task(trigger_crawler, params)
```

### 2. ç¼“å­˜æœºåˆ¶
å¯¹é¢‘ç¹æŸ¥è¯¢çš„æ•°æ®ä½¿ç”¨ç¼“å­˜ï¼š
```python
# Redisç¼“å­˜æŸ¥è¯¢ç»“æœ
cache_key = f"summary:{date}"
if cached := redis.get(cache_key):
    return cached
```

### 3. é™æµä¿æŠ¤
é˜²æ­¢æ»¥ç”¨ï¼š
```python
# é™åˆ¶æ¯ä¸ªç”¨æˆ·çš„è¯·æ±‚é¢‘ç‡
if not rate_limiter.allow(user_id):
    return {"text": "è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•"}
```

## å®‰å…¨è€ƒè™‘

### 1. è¯·æ±‚éªŒè¯
```python
# éªŒè¯é£ä¹¦ç­¾å
def verify_signature(timestamp, nonce, signature):
    # å®ç°ç­¾åéªŒè¯é€»è¾‘
    pass
```

### 2. æƒé™æ§åˆ¶
```python
# æ£€æŸ¥ç”¨æˆ·æƒé™
if command_type == 'trigger_crawler':
    if not is_admin(user_id):
        return {"text": "â›” æƒé™ä¸è¶³"}
```

### 3. è¾“å…¥éªŒè¯
```python
# éªŒè¯æ—¥æœŸæ ¼å¼
if not is_valid_date(date_str):
    return {"text": "âŒ æ—¥æœŸæ ¼å¼é”™è¯¯"}
```

## ç›‘æ§ä¸æ—¥å¿—

### å…³é”®æŒ‡æ ‡
- æ¶ˆæ¯å¤„ç†é‡
- å‘½ä»¤è¯†åˆ«ç‡
- å“åº”æ—¶é—´
- é”™è¯¯ç‡

### æ—¥å¿—è®°å½•
```python
logger.info(f"æ”¶åˆ°å‘½ä»¤: {command_type}, ç”¨æˆ·: {user_id}")
logger.error(f"å¤„ç†å¤±è´¥: {error}, æ¶ˆæ¯: {message_id}")
```
